# codelab-genai

A minimal Spring Boot application demonstrating how to call Google Cloud Vertex AI (Gemini) from Java. The app exposes a simple HTTP GET endpoint that returns HTML with “fun facts” about a requested animal by prompting the Gemini 1.5 Flash model.

- Main class: `src/main/java/com/example/demo/DemoApplication.java`
- Endpoint: `GET /?animal=<name>`
- Model: `gemini-1.5-flash` via `google-cloud-vertexai`

## Features
- Spring Boot 3 (Java 17)
- Vertex AI client libraries for Java
- Simple REST endpoint that returns HTML generated by Gemini

## Prerequisites
- A Google Cloud project with Vertex AI API enabled
- gcloud CLI (recommended) or a service account key for local credentials

## Authentication and Project Configuration
The code uses `ServiceOptions.getDefaultProjectId()` to find your Google Cloud project, so you must configure one of the following:

1) Using gcloud (recommended):
- Authenticate and set the active project:
  ```bash
  gcloud auth login
  gcloud auth application-default login
  gcloud config set project <YOUR_GCP_PROJECT_ID>
  ```

2) Using a service account key file:
- Create and download a JSON key with appropriate Vertex AI permissions.
- Set the environment variables:
  ```bash
  export GOOGLE_APPLICATION_CREDENTIALS="/absolute/path/to/key.json"
  export GOOGLE_CLOUD_PROJECT="<YOUR_GCP_PROJECT_ID>"
  ```

Ensure the Vertex AI API is enabled in your project:
```bash
gcloud services enable aiplatform.googleapis.com --project=<YOUR_GCP_PROJECT_ID>
```

## Running Locally
1) Install dependencies and run the app:
```bash
mvn spring-boot:run
```

2) Call the endpoint in a browser or with curl:
- Default animal (dog): `http://localhost:8080/`
- Specific animal: `http://localhost:8080/?animal=cat`

Using curl:
```bash
curl "http://localhost:8080/?animal=otter" -H "Accept: text/html"
```
The response is an HTML string generated by Gemini.

## Building and Testing
- Run tests:
  ```bash
  mvn test
  ```
- Build an executable jar:
  ```bash
  mvn -DskipTests package
  ```
  The jar will be created under `target/`.

## How It Works
The controller in `DemoApplication.java` does the following:
- Reads the active GCP project from ADC: `ServiceOptions.getDefaultProjectId()`
- Creates a Vertex AI client: `new VertexAI(projectId, null)`
- Instantiates the Gemini model: `new GenerativeModel("gemini-1.5-flash", vertexAI)`
- Sends a prompt like: `"Give me 20 fun facts about <animal>. Return this as html."`
- Returns the generated HTML to the caller.

## Common Issues
- Missing/invalid credentials: Configure ADC using `gcloud auth application-default login` or set `GOOGLE_APPLICATION_CREDENTIALS`.
- Project not set: Run `gcloud config set project <PROJECT_ID>` or set `GOOGLE_CLOUD_PROJECT`.
- API not enabled: Enable Vertex AI: `gcloud services enable aiplatform.googleapis.com`.
- Firewall/Proxy: Ensure your environment can reach Google APIs.

## Deployment Notes
This app is compatible with Cloud Run or any container-based deployment. For Google Cloud Buildpacks, the included `project.toml` sets the Java runtime to 17. Example with Cloud Run:
```bash
gcloud run deploy codelab-genai \
  --source . \
  --region <REGION> \
  --allow-unauthenticated \
  --project <YOUR_GCP_PROJECT_ID>
```
Make sure the service account running Cloud Run has access to Vertex AI and that ADC is configured in the deployed environment (this typically happens automatically on Cloud Run).

## Security Considerations
- Do not expose sensitive keys in source control.
- Prefer workload identity over long-lived keys where possible.
- Validate/limit user input if you expose the endpoint publicly.
